# Etude d'un malware

Plusieurs outils s'offrent à nous pour étudier un malware.
Selon si celui ci peut être de différente forme:

* une simple redirection (fishing ou ameçonnage)
* s'exécute pour impacter une cible (virus, vers, ransomware...)
* collecte des informations (spyware, cheval de Troie, keylogger...)

Selon la dangereusité, on utilisera différents outils.

## Obfuscation (obscurcissement) de code

Technique qui consiste à rendre illisible pour un humain un programme, tout en le gardant pleinement fonctionnel: pour cela on va utiliser un langage correctement interprété par la machine, mais non compréhensible par un être humain

### UTF8

Le standard international Unicode comprend l’intégralité des caractères et éléments textuels de toutes les langues du monde (ou presque) pour le traitement informatique. Si vous parvenez à lire un site Internet en anglais ou un e-mail en japonais, c’est que maîtrisez ces langues, qui sont "traduites" par le standard UTF8, c'est donc un codage intélligible par un être humain.

### binaire

### hexadécimal

### base64

## Analyse statique d'un malware

Dans le cadre par exemple d'un courriel malveillant, nous pouvons regarder le contenu, les éventuelles pièces jointes ou redirection avec des outils mais en évitant (jamais, jamais, jamais) d'exécuter le code.

Pour cela on retrouve sur la toile de nombreux sites, plus ou moins sérieux.

### Outils en ligne

Par exemple pour tester un mail louche envoyé, on va l'exporter sans l'ouvrir:
  * pour un courriel outlook, le simple fait de l'enregistrer (msg) fonctionne
  * pour thunderbid, c'est plus compliqué il faut: mail ouvert -> More -> View Source -> File -> Save page as.

#### URLSCAN

Avec le mail que vous venez d'exporter:

 Depuis urlscan (https://urlscan.io/) transférez le, et regardons ce qu'il tente de faire:
  * on suit la ou les redirection(s)
  * on a une remontée d'alerte de urlscan
  
#### Pandora

_Dans un cadre professionnel il peut être fortement déconseillé de transférer un courriel sur un site web. Voyons le cas d'une installation d'un outil en local pour test_

Pandora n'est pas une SANDBOX. ça suffit néanmoins pour analyser un fichier / une pièce jointe pour avoir une première idée d'un contenu.
Il s'appuie sur de nombreux autres sites via des modules pour les remontées d'informations.

A noter qu'une version de pandora est en ligne, accessible:
* par son site web: https://pandora.circl.lu/submit
* par la messagerie: pandora@circl.lu
 
#### VirusTotal

Téléchargeons un virus à l'adresse suivante: https://bazaar.abuse.ch/sample/fe9b163fd9645a16adea5f4655be3d072e5459e753f52c3d292637f5d41062c9/

Ici le virus (stub.exe), est un exécutable Windows donc innofensif sur notre machine Kali. Evitez de le transférer, et l'exécuter sur votre machine source!

De manière générale lorsqu'on a un doute, c'est une bonne idée d'uploader un fichier suspect sur la référence du genre: https://www.virustotal.com/fr/

En effet le site va comparer l'empreinte numérique du fichier avec d'autres précédémment uploadés sur leur site, ce qui donnera une première idée. Ensuite il pourra regarder son contenu pour y déceler des codes malicieux assez grossiers.

### A la mano
Toujours dans l'exemple du virus `stub.exe`, on peut essayer d'en voir son contenu en local depuis notre machine Kali.

Analysons le code avec la commande `string` qui va nous permettre de voir toutes les chaînes de caractères lisibles dans notre malware.

Vous pouvez rediriger la sortie écran vers un fichier pour regarder son contenu de manière un peu plus confortable:

```
strings Stub.exe > resultat.txt
```

On peut avoir des informations pertinentes

## Analyse dynamique

Avec les solutions vues précédement, nous avons une idée du type de menaces dans les grandes lignes. Cependant nous ne savons pas exactement comment le malware fonctionne, et c'est bien trop risqué de tenter de l'analyser sur un poste en local.
De plus les malwares actuels sont intelligents...ils vont faire un panel de tests pour s'assurer qu'ils ne sont pas en environnement virtuel et/ou observés pour comprendre leur fonctionnement. 

Il va falloir alors en environnement qui simule une vraie victime pour que le malware se lance normalement, nous allons alors utiliser une sandbox.

### Outils en ligne

Plusieurs sites sont disponibles, dont celui ci : https://www.hybrid-analysis.com

Reprenons l'exécutable téléchargé auparavant et uploadons le. Il y a une première analyse effectuée (dont virustotal qu'on retrouve) et ensuite l'exécution dans une sandbox.

Choisissez l'environnement Windows7 64b pour qu'on soit sûr d'avoir tous le même résultat. Une fois le test finalisé vous recevrez l'étude dans votre boit mail, c'est également consultable depuis le site internet. Ce qui est intéressant ici, c'est que l'exécutable est lancé, et on voit donc les différentes étapes du malware, les fichiers modifiées... on a donc une réelle idée des dégâts que celui ci peut faire.

### Sandbox locale

Dans certains cas il peut être sensible d'envoyer un fichier / dossier sur internet. Dans ce cas on peut utiliser une sandbox locale, qui exécutera donc du code dans un environnement isolé du reste de l'infrastructure.

Certains acteurs proposent d'utiliser une machine virtuelle comme sandbox, attention jeu dangereux! En effet il y a une passerelle entre la VM et votre système d'exploitation source, et à moins d'être sûr d'avoir bien imperméabilisé la machine virtuelle il vaut mieux éviter.

Exemple de projet de sandbox locale: 

  * Linux: https://github.com/kevoreilly/CAPEv2
  * Windows: https://github.com/sandboxie-plus/Sandboxie

Enfin il existe un projet qui s'appuie sur le noyau linux pour lancer des programmes dans une sandbox dédiée. Ce n'est pas un OS à part mais c'est sécurisé, pratique pour tester un unique outil suspect: https://firejail.wordpress.com/



