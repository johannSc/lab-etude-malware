# capeV2_sandbox

url: https://github.com/kevoreilly/CAPEv2

Les malwares actuels sont intelligents...ils vont faire un panel de tests pour s'assurer qu'ils ne sont pas en environnement virtuel et/ou observés pour comprendre leur fonctionnement.
Il va falloir alors cacher le fait que nous soyons en environement de type sandbox pour que le malware se lance correctement.

L'intérêt de CAPE est qu'il n'observe pas les instructions du malware à l'intérieur de la VM, mais depuis une autre machine pour tromper le malware.

## Mise en place du TD

Installation de Ubuntu 22.04 via vagrant cloud (bento/ubuntu22.04):
vagrant init bento

=> une fois la VM déployée, on paramètre la possibilité de gérer la virtualisation dans de la virtualisation (nested virtualization)
  minima 2Gb RAM
  2CPU
  Activer le nested CPU
  paravirtualization: KVM
  
=> on paramètre le port 8000 local vers le port 8000 de la VM
dans le Vagrantfile:
config.vm.network

Puis on lance la VM
vagrant up

### installation cape2

 wget https://raw.githubusercontent.com/doomedraven/Tools/master/Virtualization/kvm-qemu.sh
 chmod +x kvm-qemu.sh
 sudo ./kvm-qemu.sh all utilisateur | tee kvm-qemu.log
 sudo shutdown -r now 

wget https://raw.github.com/doomedraven/Tools/master/Sandbox/cape2.sh
 sudo nano cape2.sh

On va modifier le script cape2.sh pour modifier une adresse ip pour Tor (IFACE_IP = ip de la carte que l’on va créer dans kvm-qemu, en suivant le prochain article : 192.168.100.1), modifier le mot de passe pour la base de données (PASSWD) et l’utilisateur pour la base de données (USER). On peut également changer NETWORK_IFACE si on utilise autre chose que kvm-qemu (cela peut aussi être modifié dans les fichiers de configuration plus tard).
 sudo nano cape2.sh
 chmod +x cape2.sh
 sudo ./cape2.sh all
 sudo chown -R cape:cape /opt/CAPEv2/data/
 ls cd /usr/local/lib/python3.8/dist-packages/volatility3/symbols
 sudo wget https://downloads.volatilityfoundation.org/volatility3/symbols/windows.zip -O /usr/local/lib/python3.8/dist-packages/volatility3/symbols/windows.zip
 cd /usr/local/lib/python3.8/dist-packages/volatility3/symbols/
 sudo unzip windows.zip
 sudo rm windows.zip
 sudo chmod 777 windows/*
 sudo shutdown -r now
 
 Si l’installation c’est bien passée, vous pouvez vous rentre à http://ip_du_serveur:8000

### MAJ CAP2

Pour mettre à jour CAPEv2.
$ cd /opt/CAPEv2
$ git init
$ git remote add kevoreilly https://github.com/kevoreilly/CAPEv2.git
$ git fetch kevoreilly
$ git pull –rebase kevoreilly master # 2 – avant rebase (pour conserver ses modifications)
$ sudo python3 utils/community.py -waf

### Test d'un malware sans VM client

site malware trafic, pcap

##

