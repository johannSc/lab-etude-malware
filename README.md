# Etude d'un malware

Plusieurs outils s'offrent à nous pour étudier un malware.
Selon si celui ci peut être de différente forme:

* une simple redirection (fishing ou ameçonnage)
* s'exécute pour impacter une cible (virus, vers, ransomware...)
* collecte des informations (spyware, cheval de Troie, keylogger...)

Selon la dangereusité, on utilisera différents outils.

## Analyse statique d'un malware

Dans le cadre par exemple d'un courriel malveillant, nous pouvons regarder le contenu, les éventuelles pièces jointes ou redirection avec des outils mais en évitant (jamais, jamais, jamais) d'exécuter le code.

Pour cela on retrouve sur la toile de nombreux sites, plus ou moins sérieux.

### Outils en ligne

#### URLSCAN

_Exemple d'un cas de fishing, transférons un mail reçu en ligne_

 Depuis urlscan (https://urlscan.io/):
  > on suit la ou les redirection(s)
  > on a une remontée d'alerte de urlscan
  
#### Pandora

_Dans un cadre professionnel il peut être fortement déconseillé de transférer un courriel sur un site web. Voyons le cas d'une installation d'un outil en local pour test_

Pandora n'est pas une SANDBOX. ça suffit néanmoins pour analyser un fichier / une pièce jointe pour avoir une première idée d'un contenu.
Il s'appuie sur de nombreux autres sites via des modules pour les remontées d'informations.

Par exemple pour tester un mail louche envoyé, on peut utiliser les deux méthodes:

- envoi sur une adresse mail en interne
- passage par l'interface graphique de pandora
    * pour un courriel outlook, le simple fait de l'enregistrer (msg) fonctionne
    * pour thunderbid, c'est plus compliqué il faut: mail ouvert -> More -> View Source -> File -> Save page as.

A noter qu'une version de pandora est en ligne, accessible:
* par son site web: https://pandora.circl.lu/submit
* par la messagerie: pandora@circl.lu
 
#### Fichiers

Etudions un virus connu, qui ici est un exécutable donc innofensif sur notre machine Kali. Evitez de le transférer, et l'exécuter sur votre machine source...

De manière générale lorsqu'on a un doute, c'est une bonne idée d'uploader un fichier suspect sur la référence du genre: https://www.virustotal.com/fr/

En effet le site va comparer l'empreinte numérique du fichier avec d'autres précédémment uploadés sur leur site, ce qui donnera une première idée. Ensuite il pourra regarder son contenu pour y déceler des codes malicieux assez grossiers.

### A la mano
Toujours dans l'exemple du virus `stub.exe`, on peut essayer d'en voir son contenu en local depuis notre machine Kali.

Analysons le code avec la commande `string` qui va nous permettre de voir toutes les chaînes de caractères lisibles dans notre malware.

## Analyse dynamique

Avec les solutions vues précédement, nous avons une idée du type de menaces dans les grandes lignes. Cependant nous ne savons pas exactement comment le malware fonctionne, et c'est bien trop risqué de tenter de l'analyser sur un poste en local.
De plus les malwares actuels sont intelligents...ils vont faire un panel de tests pour s'assurer qu'ils ne sont pas en environnement virtuel et/ou observés pour comprendre leur fonctionnement. 

Il va falloir alors en environnement qui simule une vraie victime pour que le malware se lance normalement, nous allons alors utiliser une sandbox.

### Outils en ligne

Exemple d'un cas de cheval de Troie (Trojan):
Exemple de l'url malveillante https://rb.gy/fibu1 depuis Hybrid Analysis (https://www.hybrid-analysis.com/)
Ici il y a une sandbox locale

### Sandbox locale: CAPEV2

https://github.com/kevoreilly/CAPEv2
