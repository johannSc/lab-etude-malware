# Etude d'un malware

Plusieurs outils s'offrent à nous pour étudier un malware.
Selon si celui ci peut être de différente forme:

* une simple redirection (fishing ou ameçonnage)
* s'exécute pour impacter une cible (virus, vers, ransomware...)
* collecte des informations (spyware, cheval de Troie, keylogger...)

Selon la dangereusité, on utilisera différents outils.

## Analyse rapide d'un malware

Dans le cadre par exemple d'un courriel malveillant, nous pouvons rapidement regarder le contenu, les éventuelles pièces jointes ou redirection avec des outils qui nous éviterons d'ouvrir celui ci sur une machine local pour expertise

### Outils en ligne

#### URLSCAN

_Exemple d'un cas de fishing, transférons un mail reçu en ligne_

 Depuis urlscan (https://urlscan.io/):
  > on suit la ou les redirection(s)
  > on a une alerte de urlscan
  
#### Pandora

_Dans un cadre professionnel il peut être fortement déconseillé de transférer un courriel sur un site web. Voyons le cas d'une installation d'un outil en local pour test_

Pandora n'est pas une SANDBOX. ça suffit néanmoins pour analyser un fichier / une pièce jointe pour avoir une première idée d'un contenu.
Il s'appuie sur de nombreux autres sites via des modules pour les remontées d'informations.

Un logiciel malveillant peut être testé de différentes manières, selon le type:

##### Courriel

Pour tester un mail louche envoyé, on peut utiliser les deux méthodes

- envoi sur une adresse mail en interne
- passage par l'interface graphique de pandora
    * pour un courriel outlook, le simple fait de l'enregistrer (msg) fonctionne
    * pour thunderbid, c'est plus compliqué il faut: mail ouvert -> More -> View Source -> File -> Save page as.

A noter qu'une version de pandora est en ligne, accessible
* par son site web
* par la messagerie: pandora@circl.lu
 
##### Fichiers

## Analyse complète

Avec les solutions vues précédement, nous avons une idée du type de menaces dans les grandes lignes. Cependant nous ne savons pas exactement comment le malware fonctionne, et c'est bien trop risqué de tenter de l'analyser sur un poste en local.
De plus les malwares actuels sont intelligents...ils vont faire un panel de tests pour s'assurer qu'ils ne sont pas en environnement virtuel et/ou observés pour comprendre leur fonctionnement. Il va falloir alors en environnement qui simule une vraie victime pour que le malware se lance normalement, nous allons alors utiliser une sandbox.

### Outils en ligne

Exemple d'un cas de cheval de Troie (Trojan):
Exemple de l'url malveillante https://rb.gy/fibu1 depuis Hybrid Analysis (https://www.hybrid-analysis.com/)
Ici il y a une sandbox locale

### Sandbox locale: CAPEV2

https://github.com/kevoreilly/CAPEv2
L'intérêt de CAPE est qu'il n'observe pas les instructions du malware à l'intérieur de la VM, mais depuis une autre machine pour tromper le malware.

#### Préparation du TD

Installation de Ubuntu 22.04 via vagrant cloud (bento/ubuntu22.04):
vagrant init bento

=> une fois la VM déployée, on paramètre la possibilité de gérer la virtualisation dans de la virtualisation (nested virtualization)
  minima 2Gb RAM
  2CPU
  Activer le nested CPU
  paravirtualization: KVM
  
=> on paramètre le port 8000 local vers le port 8000 de la VM
dans le Vagrantfile:
config.vm.network

Puis on lance la VM
vagrant up

### Installation Cape2

 wget https://raw.githubusercontent.com/doomedraven/Tools/master/Virtualization/kvm-qemu.sh
 chmod +x kvm-qemu.sh
 sudo ./kvm-qemu.sh all utilisateur | tee kvm-qemu.log
 sudo shutdown -r now 

wget https://raw.github.com/doomedraven/Tools/master/Sandbox/cape2.sh
 sudo nano cape2.sh

On va modifier le script cape2.sh pour modifier une adresse ip pour Tor (IFACE_IP = ip de la carte que l’on va créer dans kvm-qemu, en suivant le prochain article : 192.168.100.1), modifier le mot de passe pour la base de données (PASSWD) et l’utilisateur pour la base de données (USER). On peut également changer NETWORK_IFACE si on utilise autre chose que kvm-qemu (cela peut aussi être modifié dans les fichiers de configuration plus tard).
 sudo nano cape2.sh
 chmod +x cape2.sh
 sudo ./cape2.sh all
 sudo chown -R cape:cape /opt/CAPEv2/data/
 ls cd /usr/local/lib/python3.8/dist-packages/volatility3/symbols
 sudo wget https://downloads.volatilityfoundation.org/volatility3/symbols/windows.zip -O /usr/local/lib/python3.8/dist-packages/volatility3/symbols/windows.zip
 cd /usr/local/lib/python3.8/dist-packages/volatility3/symbols/
 sudo unzip windows.zip
 sudo rm windows.zip
 sudo chmod 777 windows/*
 sudo shutdown -r now
 
 Si l’installation c’est bien passée, vous pouvez vous rentre à http://ip_du_serveur:8000

### MAJ CAP2

Pour mettre à jour CAPEv2.
$ cd /opt/CAPEv2
$ git init
$ git remote add kevoreilly https://github.com/kevoreilly/CAPEv2.git
$ git fetch kevoreilly
$ git pull –rebase kevoreilly master # 2 – avant rebase (pour conserver ses modifications)
$ sudo python3 utils/community.py -waf



### Ref

ref:https://www.malware-traffic-analysis.net/
